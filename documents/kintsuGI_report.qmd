---
title: "KintsuGI Report"
author: "Joe Shaw (CS20980)"
format: pdf
editor: visual
---

```{r}
#| label: packages
#| include: FALSE

library(tidyverse)
library(janitor)

```

```{r}
#| label: load-data
#| include: FALSE

gi_csv_cleaned_orps <- read_csv(paste0(config::get("data_folderpath"),
                                       "02_cleaned/gi_csv_cleaned_orps.csv"))

gi_csv_cleaned_orpp <- read_csv(paste0(config::get("data_folderpath"),
                                       "02_cleaned/gi_csv_cleaned_orpp.csv"))

gi_glvar_joined <- read_csv(paste0(config::get("data_folderpath"),
                                   "03_joined/",
                                   "gi_glvar_joined.csv"),
                            col_types = list(
                              glvar_headline_classification = col_factor(
                                levels = c("Pathogenic",
                                                  "Likely pathogenic",
                                                  "Uncertain significance"))))

stopifnot(anyNA(gi_glvar_joined$glvar_headline_result) == FALSE)

stopifnot(anyDuplicated(gi_glvar_joined$nhsno) == 0)

glvar_tvar_joined <- read_csv(paste0(config::get("data_folderpath"),
                                   "03_joined/",
                                   "glvar_tvar_joined.csv"))

gi_tvar_joined <- read_csv(paste0(config::get("data_folderpath"),
                                   "03_joined/",
                                   "gi_tvar_joined.csv"),
                           col_types = list(
                              tvar_headline_classification = col_factor(
                                levels = c("Pathogenic",
                                           "Likely pathogenic",
                                           "Uncertain significance",
                                           "Not reported",
                                           NA))))

```

```{r}
#| label: tbl-gi-results
#| echo: FALSE
#| tbl-cap: "GI results"

tbl_gi_orps <- gi_csv_cleaned_orps |> 
  group_by(status) |> 
  count() |> 
  rename("Samples" = n)

tbl_gi_orpp <- gi_csv_cleaned_orpp |> 
  group_by(status) |> 
  count() |> 
  rename("Patients" = n)

tbl_gi_results <- tbl_gi_orps |> 
  left_join(tbl_gi_orpp, by = "status") |> 
  rename("GI status" = status) |> 
  adorn_totals()

knitr::kable(tbl_gi_results)

```


```{r}
#| label: conclusive-results
#| include: FALSE

gi_glvar_joined_conclusive <- gi_glvar_joined |> 
  filter(status != "Non-conclusive" &
           glvar_headline_result %in% c("No reportable variant(s) detected",
                                        "Reportable variant(s) detected"))

gi_tvar_joined_conclusive <- gi_tvar_joined |> 
  filter(status != "Non-conclusive" &
           tvar_headline_result %in% c("No reportable variant(s) detected",
                                        "Reportable variant(s) detected"))

```

```{r}
#| label: tbl-gi-glvar
#| echo: FALSE
#| tbl-cap: "GI results and germline testing results"

tbl_gi_glvar <- gi_glvar_joined_conclusive |>
  group_by(status, glvar_headline_result) |> 
  count() |> 
  rename("GI status" = status,
         "Germline result" = glvar_headline_result,
         "Patients" = n) |> 
  adorn_totals()

knitr::kable(tbl_gi_glvar)

```

```{r}
#| label: tbl-gi-tvar
#| echo: FALSE

tbl_gi_tvar <- gi_tvar_joined_conclusive |> 
  group_by(status, tvar_headline_result) |> 
  count() |> 
  rename("Patients" = n,
         "Tumour result" = tvar_headline_result,
         "GI status" = status) |> 
  adorn_totals()

knitr::kable(tbl_gi_tvar)

```


```{r}
#| label: fig-gi-gl-results-variants
#| echo: FALSE
#| fig-cap: "GI results for patients with reportable germline variants"

variant_class_colours <- c("#FF3300",
                           "#FF9900",
                           "#CCCCCC")

gi_glvar_plot <- gi_glvar_joined_conclusive |> 
  filter(glvar_headline_result == "Reportable variant(s) detected") |> 
  ggplot(aes(x = gl_gene, y = score)) +
  geom_jitter(shape = 21, 
              size = 2,
              width = 0.1, 
              alpha = 0.8,
              aes(fill = glvar_headline_classification)) +
  theme_bw() +
  scale_fill_manual(values = variant_class_colours) +
  labs(x = "Germline gene",
       fill = "Variant classification",
       y = "SeqOne GI score")

gi_glvar_plot

```

```{r}
#| label: fig-gi-t-results-variants
#| echo: FALSE
#| fig-cap: "GI results for patients with somatic BRCA1/2 variants"

gi_tvar_plot <- gi_tvar_joined_conclusive |> 
  filter(tvar_headline_result == "Reportable variant(s) detected") |>
  filter(tvar_gene %in% c("BRCA1","BRCA2")) |> 
  ggplot(aes(x = tvar_gene,
             y = score)) +
  geom_jitter(shape = 21, aes(fill = tvar_headline_classification),
              width = 0.2) +
  theme_bw() +
  scale_fill_manual(values = variant_class_colours) +
  geom_hline(yintercept = 0.5, linetype = "dashed") +
  labs(x = "Tumour gene", y = "SeqOne GI score",
       fill = "Variant classification")

gi_tvar_plot

```

```{r}
#| label: tbl-gi-neg-gl-pos
#| echo: FALSE
#| tbl-cap: "GI negative samples with germline BRCA variants"

glvar_neg_gi <- gi_glvar_joined |> 
  filter(glvar_headline_result == "Reportable variant(s) detected") |> 
  filter(status != "Non-conclusive") |> 
  filter(score < 0.5) |> 
  filter(glvar_seqv1_classification %in% c("Pathogenic", "Likely pathogenic")) |> 
  filter(gl_gene %in% c("BRCA1", "BRCA2"))
  
knitr::kable(glvar_neg_gi |> 
               select(nhsno, surname, score, glvar_seqv1_description) |> 
               mutate(score = round(score, 2)))

```

```{r}
#| label: tbl-tvar-neg-hi
#| echo: FALSE
#| tbl-cap: "GI negative samples with tumour BRCA variants"

tvar_neg_gi <- gi_tvar_joined_conclusive |> 
  filter(tvar_headline_result == "Reportable variant(s) detected") |>
  filter(tvar_gene %in% c("BRCA1","BRCA2")) |> 
  filter(score < 0.5) |> 
  select(nhsno, surname, score, tvar_seqv1_description) |> 
               mutate(score = round(score, 2))

knitr::kable(tvar_neg_gi)

```

```{r}
#| label: glvar-vs-tvar
#| include: FALSE

glvar_tvar_brca <- glvar_tvar_joined |> 
  filter(gl_gene %in% c("BRCA1", "BRCA2") &
           glvar_seqv1_classification %in% c("Pathogenic",
                                             "Likely pathogenic") &
           tvar_headline_result == "Reportable variant(s) detected") |> 
  select(nhsno, labno.x, labno.y, rno.x, rno.y, gl_gene, glvar_seqv1_description,
         tvar_seqv1_description,
         glvar_seqv1_classification,
         tvar_seqv1_classification) 

```
